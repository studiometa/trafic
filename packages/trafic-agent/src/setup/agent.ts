import { step, success, info, exec, commandExists } from "./steps.js";
import { writeFileSync } from "node:fs";

/**
 * Install Node.js using fnm
 */
export function installNode(): void {
  step("Install Node.js");

  // Check if Node is already installed
  if (commandExists("node")) {
    const version = exec("node --version", { silent: true });
    info(`Node.js already installed: ${version?.trim()}`);
    return;
  }

  // Install fnm (Fast Node Manager)
  exec(
    'curl -fsSL https://fnm.vercel.app/install | bash -s -- --install-dir "/opt/fnm" --skip-shell',
  );

  // Add fnm to system path
  const profileContent = `# Trafic: fnm (Node.js version manager)
export FNM_DIR="/opt/fnm"
export PATH="/opt/fnm:$PATH"
eval "$(fnm env)"
`;

  writeFileSync("/etc/profile.d/fnm.sh", profileContent);
  exec("chmod 644 /etc/profile.d/fnm.sh");

  // Install Node.js 24
  exec("export FNM_DIR=/opt/fnm && /opt/fnm/fnm install 24");
  exec("export FNM_DIR=/opt/fnm && /opt/fnm/fnm default 24");

  // Create symlinks for system-wide access
  exec(
    "ln -sf /opt/fnm/aliases/default/bin/node /usr/local/bin/node || true",
  );
  exec("ln -sf /opt/fnm/aliases/default/bin/npm /usr/local/bin/npm || true");
  exec("ln -sf /opt/fnm/aliases/default/bin/npx /usr/local/bin/npx || true");

  success("Node.js 24 installed via fnm");
}

/**
 * Install the Trafic agent
 */
export function installAgent(): void {
  step("Install Trafic agent");

  // Install the agent globally
  exec("npm install -g @studiometa/trafic-agent");

  success("Trafic agent installed");
}

/**
 * Create the agent configuration
 */
export function createAgentConfig(tld: string, _email?: string): void {
  step("Create agent configuration");

  // Create directories
  exec("mkdir -p /etc/trafic");
  exec("mkdir -p /var/lib/trafic");
  exec("chown ddev:ddev /var/lib/trafic");

  const config = `# Trafic agent configuration
# Generated by trafic setup

# Required: TLD for DDEV projects
tld = "${tld}"

# Agent HTTP server port
port = 9876

# Database and paths
db_path = "/var/lib/trafic/db.sqlite"
project_list_path = "/home/ddev/.ddev/project_list.yaml"
projects_dir = "/home/ddev/www"

# Scale-to-zero settings
idle_timeout = "4h"
idle_check_interval = "5m"

# Authentication
[auth]
default_policy = "basic"
allowed_ips = []
tokens = []
basic_auth = []
rules = []
`;

  writeFileSync("/etc/trafic/config.toml", config);
  exec("chmod 640 /etc/trafic/config.toml");
  exec("chown root:ddev /etc/trafic/config.toml");

  success("Configuration created at /etc/trafic/config.toml");
  info("Edit this file to configure authentication");
}

/**
 * Create systemd service for the agent
 */
export function createSystemdService(): void {
  step("Create systemd service");

  // Find the trafic-agent binary path
  const agentPath = exec("which trafic-agent", { silent: true })?.trim() || "/usr/bin/trafic-agent";

  const serviceContent = `[Unit]
Description=Trafic Agent - DDEV preview environment manager
After=network.target docker.service
Requires=docker.service

[Service]
Type=simple
User=ddev
Group=ddev
ExecStart=${agentPath} start --config /etc/trafic/config.toml
Restart=always
RestartSec=5
StandardOutput=journal
StandardError=journal
SyslogIdentifier=trafic-agent

# Environment
Environment=NODE_ENV=production

# Security hardening
NoNewPrivileges=true
ProtectSystem=strict
ProtectHome=read-only
ReadWritePaths=/var/lib/trafic /home/ddev/.ddev
PrivateTmp=true

[Install]
WantedBy=multi-user.target
`;

  writeFileSync("/etc/systemd/system/trafic-agent.service", serviceContent);
  exec("chmod 644 /etc/systemd/system/trafic-agent.service");

  // Reload systemd and enable service
  exec("systemctl daemon-reload");
  exec("systemctl enable trafic-agent");
  exec("systemctl start trafic-agent");

  success("Trafic agent service started");
  info("View logs: journalctl -u trafic-agent -f");
}
